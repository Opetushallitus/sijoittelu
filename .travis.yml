sudo: required

language: java

jdk:
- openjdk11

services:
- docker

cache:
  directories:
  - $HOME/.m2

env:
  global:
  # ARTIFACTORY_USERNAME
  - secure: "EpG6vdeZkIRN783AlvpBjpRn13F1Tp5DnVvARLtt6tG/qnhwmO16C5155LpBlYZRJyOCEHGAYsYy28UPyVGjDXgZ6iWfDPJyhFW8og+ARxTHsY4H46lcP8Tu9F2/8viJiwdqsjSW7ddgHRiOtspzoJGPnZu7FGEXuZJTP0s3D9Xdt9ipPbxdnE/Q5E1ahN3cYDrVOUEPrBYmnObV9qm7+y3QvE+8j8IfYzj/6P1UZF5Rn1M/ti517N81ggKdvz69U5UBDNeBlZrYqbjI5gYOJ7ZYKbwT/tFvWojubG6BdKOnphzcD3DYDC3zIur+Rn6ssGk7x6wJn8YwlkaXyK33xcukFLUPNfjV3yQDbn2kR9tpJwiZ7nbjyabBTbmWIHj9NwU0SUGLgZk+QnI1lzTz8Z7GIeZT4huCJlgIMr6/jEZ0onwuwNDWTnq+R/qZkziQvEQl8fQClbCzTAWip4ZhDjefF4KQ4AnPn7x1pUk8ZE9MX0bGzALYPCYdFjyvxJAFd5ja15cKAkSFDj5t+TGsrfZbHAQVcUqNu5oB3fhOPAYnuLP/+cUhD8i4CXfdyDFeFuIwyqM12nirTeuOO5m5D6LEeiBUiLD3Hrh4sDVeTWdvf7nqUf7Yrimn2g2xDH+dF9s0F7XtDTXXLFa/q2t1tkFTstyh9MoZBiHOHpGu9m8="
  # ARTIFACTORY_PASSWORD
  - secure: "ZphErctReTsfwJso9x+i0+fcUlmC+8pNMKDA2V6pnpVfjrD2KJGjZ35LrBVnyrDZ2lhbJMta9vBJEx+xRnkKhjPNM1MPIsing97JMF5fjKAvV9cwHDXGs24zrcNri78TeKG9Y5gVJGPV0FQPA836I+pCuBhYyNQCLjj+w1LvLlDLxsT3V0neRJkRYgs6NfvWVR4B7A1+xaiq5ovxlqbowhW37TfprptqnPPdCpJ/7rsKUzef1QhMSV42AhCvaZS3BbVkLbnt0uZe24iahkhToguO9Su4GGDiIL0kxw3PT5Ft+OYNCBIiszRdcFKKzfaDgf5ijyhcihXuRWiLkKuTMlabdK/F46BtVF/fBTXhsm/lWMP7AShLKWR8gCbMTATiyKKGqTopinJvF2JRxhK5nupAY9CEw6zb5+YL96qOyjHbGgnBtQiY78spVXgmhwk4olITTU+6D5EjjbZHOo34agDp6dArKh9TjH/qdYTmZrOCNsk46Aqq4/iJdJwVHD8dXNIQ07QUc3XgX5Q/dMS1TIdKp9kKew30J0zM2ig0mhNJVEicnsFzR3/JPl9n8SiW/f5jsf0n1M6yagQvipgO+tq+IDyd660yn5Csuq84LQnZQACGEuBp+7hinu/ERQ+Gpgjdf8aFPii1RaFtD/+OzrzvThbsxPz00LZNLkcOsZo="
  # AWS_ACCESS_KEY_ID
  - secure: "hLFEjFJPzFYlCRgy0A9dikD/ibDctd6ryus1puh5aWiyRWDGqTXXax33YGes2qi9pRMVyIdaYsTJSWDeT2VCKZsCFO1ziekdiSFTEn82TEB8a7u/fWIbf0Pjh5VD/eISryuuKJCVlGPiIbDcsvF7UXaLeq31ujQc0H2WNxyqALNENTHaaa88Do5TL1dkp+de7FbBzBGYFKxTOn+R371suSFtfBmLZWwwiO6+Yatmq0NypjUZgCyK/EWGa3QrC2tBGE5FBqGx7IXA/FYagPM94IwcrODyFZO4ki4o0/vnjPC8TctwDzOGXPMbjYnYciZfb6wsRaa2wAZc31UG/RFlMDaNACT/qVdKHsPKWuQZodE6kULOoZEQ19XvrnVl4k1QoZudcc2h+El2w5CUr8A757YTrNTL+3Um2wajKrESHKophnOoo/4XMqP5RWgFbvhGqx72gYMUpQ9qtm90dz34lDCyDWaQKsf3HUy1NBF1Wi2lAYlzqFm5TX7z9Hr6+Ie6zsn1pVy2bc3ZIuebxMwzRf2T/ORuXsmvYCexgkensvVg51znPQffj9RZNbvLk/nreGXZHeSdfcAykCnEX5+f33HG0fDosa8H+370Jks9gYcS/z1DN+HuShw2oSFbD0Od0GcavdOuxZV1uYyQy31OteQo0XTzmACfMYYg1RUHkzc="
  # AWS_SECRET_ACCESS_KEY
  - secure: "Vjslt++jC3yrjYcX9Bhd9BCeSW2Vglz0CQzI6UnxPlR8B6Z0StiKR8kPZYnK2c+aYy6LTwhiXXGwtkpfAPp4Pum9k6Gg9T/wj896bhWz0ZDukDSI2HhKvo+gePOfsQqXj+hIOYHc3OifE3Bam6RnJTqLRcew3XxK0mzkatm+vm41rC2ZLIh3R4/lWUrcrZDYrnrP7vu3WHCc3U1ettVfxINIH2J+LacEwyEeSdx3oiudUi+sZw9z3U4QqYQeAJxXN6B9n2jJPZBhhbiZlBYKLho7mi6vbJr6lYaHL/DXES4IRLQcU7P59QRI3YQ4Q8DI0R7qYMrsqFdnHZRotCj/jUqnmzeGANcRF0VgVIRABWuXg/cE3a3yMESG7Y6LkgNvbpF8EcbF8txZYoYMWzALmVf7cXtWY7+WAJG2X4odhrYvI/IU0ZaDoN9BxG4hfvRqNI72q0KpbZOvsFWSooMx3L53b1Qxc5qOpaUXpNtRmf+wWyS7m7ASF5GnbB1pjm1qWu8sj1iZBMcxadZfSUxK2kpYZxaxB/6GV0LZ+r1IsvtCAxmJ9Au5w9X9cg/WMngsTViM8WWMqZzTkGt92sDkiRAgK3J/tsSjA4Kyx0lAIjLV5CwRM4H9MF380cthcwqj6kzsGE2gRvic4PaPoq1sj7tngbQI4tGzr93Wp3E32+c="

install:
- git clone https://github.com/Opetushallitus/ci-tools.git
- source ci-tools/common/setup-tools.sh
- sudo sh -c "printf '\n%s penaali.hard.ware.fi\n' $(dig +short artifactory.opintopolku.fi|head -n1) >> /etc/hosts"
- export TZ=Europe/Helsinki
- date
- export ARTIFACT_NAME="sijoittelu-service"

script:
- mvn clean verify -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER} -Pit -Dit.usePhantomJs=true

- mv sijoittelu-service/target/sijoittelu-service-*allinone.jar $DOCKER_BUILD_DIR/artifact/${ARTIFACT_NAME}.jar
- cp -vr src/main/resources/oph-configuration $DOCKER_BUILD_DIR/config/

- export BASE_IMAGE="baseimage-fatjar-openjdk11:master"
- ./ci-tools/common/pull-image.sh
- ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
- provider: script
  script: mvn deploy -pl fi.vm.sade.sijoittelu:sijoittelu,sijoittelu-tulos-api,sijoittelu-algoritmi-domain,sijoittelu-algoritmi-batch,sijoittelu-tulos-service -DskipTests --settings ci-tools/common/maven-settings.xml
  skip_cleanup: true
  on:
    branch: master
- provider: script
  script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
  on:
    all_branches: true
